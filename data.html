<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Particulate Matter Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style2.css">
</head>
<body>
    <div class="container">
        <div class="title-container" style="align-items: center;">
            <h1 style="font-family: 'Courier New', Courier, monospace;">Overall Data</h1>
            <form action="set-location.html" method="get">
                <input style="margin-top: 10px;" type="submit" value="Update Locations">
            </form>
            <input style="width: 10%; margin-top: 30px; height: 45px; border-radius: 10px;" type="date" id="datePicker" />
            <button class="button-excel" id="exportButton">
                <img src="excel.png" alt="Excel Icon" style="width: 20px; height: 20px; margin-right: 5px;"> Export to Excel
            </button>
        </div>

        <table id="dataTable">
            <tr>
                <th>No.</th>
                <th>Timestamp</th>
                <th>Device ID</th>
                <th>Location</th>
                <th>PM2.5</th>
                <th>PM2.5 Remarks</th>
                <th>PM10</th>
                <th>PM10 Remarks</th>
                <th>Humidity</th>
                <th>Humidity Remarks</th>
                <th>Temperature</th>
                <th>Temperature Remarks</th>
                <th>Oxygen</th>
                <th>Oxygen Remarks</th>
            </tr>
        </table>
        
        <!-- Pagination Controls -->
        <div class="pagination" style="margin-left: 80%;">
            <button onclick="prevPage()">Previous</button>
            <span id="pageDisplay"></span>
            <button onclick="nextPage()">Next</button>
        </div>
    </div>

    <script>
        const apiUrl = "https://kohjcrdirmvamsjcefew.supabase.co/rest/v1/sensors";
        const apiKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtvaGpjcmRpcm12YW1zamNlZmV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjczMzA2MTMsImV4cCI6MjA0MjkwNjYxM30.nuysQR2UPTch2YbRDPYWAgp14Ofi73gL72T9j6JIDM4";

        const rowsPerPage = 20;
        let currentPage = 1;
        let data = [];

        document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'apikey': apiKey,
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) throw new Error(`Error: ${response.statusText}`);

            data = await response.json();
            data.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by timestamp
            renderPage();

            document.getElementById('exportButton').addEventListener('click', () => {
                const selectedDate = document.getElementById('datePicker').value;
                exportToExcel(data, selectedDate);
            });
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    });

        function renderPage() {
            const table = document.getElementById('dataTable');
            const pageDisplay = document.getElementById('pageDisplay');

            table.querySelectorAll("tr:not(:first-child)").forEach(row => row.remove());

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            pageData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${start + index + 1}</td>
                    <td>${formatTimestamp(row.date)}</td>
                    <td>${row.device_id}</td>
                    <td>${row.locationId}</td>
                    <td>${row.pm25}</td>
                    <td>${row.pm25Remarks}</td>
                    <td>${row.pm10}</td>
                    <td>${row.pm10Remarks}</td>
                    <td>${row.humidity}</td>
                    <td>${row.humidityRemarks}</td>
                    <td>${row.temperature}</td>
                    <td>${row.temperatureRemarks}</td>
                    <td>${row.oxygen}</td>
                    <td>${row.oxygenRemarks}</td>
                `;
                table.appendChild(tr);
            });

            pageDisplay.textContent = `Page ${currentPage} of ${Math.ceil(data.length / rowsPerPage)}`;
        }

        function nextPage() {
            if (currentPage * rowsPerPage < data.length) {
                currentPage++;
                renderPage();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderPage();
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function exportToExcel(data, selectedDate) {
        const selectedDateObj = selectedDate ? new Date(selectedDate) : new Date();
        selectedDateObj.setHours(0, 0, 0, 0);

        const filteredData = data.filter(item => {
            const itemDate = new Date(item.date);
            itemDate.setHours(0, 0, 0, 0);
            return itemDate.getTime() === selectedDateObj.getTime();
        });

        if (filteredData.length === 0) {
            alert('No data available for the selected date.');
            return;
        }

        const remarkCounts = { "Good": 0, "Poor": 0, "Unhealthy": 0, "Very Unhealthy": 0 };

        filteredData.forEach(item => {
            remarkCounts[item.pm25Remarks] = (remarkCounts[item.pm25Remarks] || 0) + 1;
            remarkCounts[item.pm10Remarks] = (remarkCounts[item.pm10Remarks] || 0) + 1;
            remarkCounts[item.humidityRemarks] = (remarkCounts[item.humidityRemarks] || 0) + 1;
            remarkCounts[item.temperatureRemarks] = (remarkCounts[item.temperatureRemarks] || 0) + 1;
            remarkCounts[item.oxygenRemarks] = (remarkCounts[item.oxygenRemarks] || 0) + 1;
        });

        const majorityRemark = Object.keys(remarkCounts).reduce((a, b) => remarkCounts[a] > remarkCounts[b] ? a : b);

        const worksheet = XLSX.utils.json_to_sheet(filteredData.map(item => ({
            id: item.id,
            locationId: item.locationId,
            pm25: item.pm25,
            pm10: item.pm10,
            humidity: item.humidity,
            temperature: item.temperature,
            oxygen: item.oxygen,
            pm25Remarks: item.pm25Remarks,
            pm10Remarks: item.pm10Remarks,
            humidityRemarks: item.humidityRemarks,
            temperatureRemarks: item.temperatureRemarks,
            oxygenRemarks: item.oxygenRemarks,
            date: new Date(item.date).toLocaleString()
        })), {
            header: ["id", "locationId", "pm25", "pm10", "humidity", "temperature", "oxygen", "pm25Remarks", "pm10Remarks", "humidityRemarks", "temperatureRemarks", "oxygenRemarks", "date"]
        });

        XLSX.utils.sheet_add_aoa(worksheet, [
            ["Overall Air Quality for " + selectedDateObj.toLocaleDateString() + ":", majorityRemark]
        ], { origin: "P1" });

        XLSX.utils.sheet_add_aoa(worksheet, [
            ["ID", "Location ID", "PM2.5", "PM10", "Humidity", "Temperature", "Oxygen", "PM2.5 Remarks", "PM10 Remarks", "Humidity Remarks", "Temperature Remarks", "Oxygen Remarks", "Date"]
        ], { origin: "A1" });

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Particulate Matter Data');

        XLSX.writeFile(workbook, `AirQuality_${selectedDateObj.toLocaleDateString()}.xlsx`);
    }
    </script>
</body>
</html>
